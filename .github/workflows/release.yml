name: Build, Release and Publish

on:
  push:
    tags:
      - "v*" # è§¦å‘æ¡ä»¶ï¼šæ¨é€ v å¼€å¤´çš„æ ‡ç­¾
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  # ç¬¬ä¸€æ­¥ï¼šåœ¨æ‰€æœ‰ Python ç‰ˆæœ¬ä¸Šæµ‹è¯•æ„å»º
  test-build:
    name: Test Build on Python ${{ matrix.python-version }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10", "3.11", "3.12", "3.13"]
      fail-fast: false

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          allow-prereleases: true

      - name: Display Python version
        run: python --version

      - name: Upgrade pip and install build tools
        run: |
          python -m pip install --upgrade pip
          python -m pip install build wheel setuptools

      - name: Test install base package
        run: |
          pip install .
          python -c "import cmai; print('Base package imported successfully')"

      - name: Test install with all providers
        run: |
          pip install ".[all_providers]"
          python -c "import cmai; import openai; import ollama; import zai; print('All providers installed successfully')"

      - name: Test build
        run: |
          python -m build
          ls -la dist/

  # ç¬¬äºŒæ­¥ï¼šæ­£å¼æ„å»ºå’Œå‘å¸ƒ
  build-and-publish:
    name: Build and Publish Package
    needs: test-build
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # è·å–æ‰€æœ‰å†å²ï¼Œä»¥ä¾¿ç”Ÿæˆæ›´å¥½çš„ changelog

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12" # ä½¿ç”¨ç¨³å®šç‰ˆæœ¬è¿›è¡Œå‘å¸ƒ

      - name: Upgrade pip and install build tools
        run: |
          python -m pip install --upgrade pip
          python -m pip install build wheel setuptools twine

      - name: Get version from tag
        id: get_version
        run: |
          echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          echo "TAG=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Verify version matches pyproject.toml
        run: |
          # å®‰è£… tomli ç”¨äº Python < 3.11
          pip install tomli
          PROJECT_VERSION=$(python -c "
          try:
              import tomllib
          except ImportError:
              import tomli as tomllib
          with open('pyproject.toml', 'rb') as f:
              data = tomllib.load(f)
              print(data['project']['version'])
          ")
          TAG_VERSION="${{ steps.get_version.outputs.VERSION }}"
          if [ "$PROJECT_VERSION" != "$TAG_VERSION" ]; then
            echo "Error: Tag version ($TAG_VERSION) doesn't match pyproject.toml version ($PROJECT_VERSION)"
            exit 1
          fi
          echo "Version check passed: $PROJECT_VERSION"

      - name: Build package
        run: |
          python -m build
          ls -la dist/
          echo "Built packages:"
          echo "---------------"
          ls -1 dist/

      - name: Check build output
        run: |
          # å®‰è£… wheel æ¥æµ‹è¯•
          pip install dist/*.whl
          python -c "import cmai; print(f'Successfully imported cmai')"
          pip show cmai

      - name: Inspect Wheel Metadata
        run: |
          pip install pkginfo
          python -c "
          import glob
          from pkginfo import Wheel
          whl = glob.glob('dist/*.whl')[0]
          metadata = Wheel(whl)
          print(f'Extras provided: {metadata.provides_extras}')
          expected = {'openai', 'ollama', 'zai', 'all_providers', 'dev'}
          if not expected.issubset(set(metadata.provides_extras)):
             print('Error: Missing extras in built wheel!')
             exit(1)
          "

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: python-packages
          path: dist/
          retention-days: 30

      - name: Check distribution
        run: |
          twine check dist/*

      # å‘å¸ƒåˆ° PyPI
      - name: Publish to PyPI
        if: "!contains(github.event.head_commit.message, '[skip-pypi]')"
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          echo "Publishing to PyPI..."
          twine upload dist/*
          echo "Package published to PyPI"
          echo "Install with: pip install cmai==${{ steps.get_version.outputs.VERSION }}"

      # ä» CHANGELOG.md æå–å½“å‰ç‰ˆæœ¬çš„ Release Notes
      - name: Extract Changelog for Version
        id: release_notes
        run: |
          VERSION="${{ steps.get_version.outputs.VERSION }}"

          # ä½¿ç”¨ Python è„šæœ¬æå–å¯¹åº”ç‰ˆæœ¬çš„ changelog
          python3 << 'PYTHON_SCRIPT' > changelog_content.md
          import re
          import sys

          version = "${{ steps.get_version.outputs.VERSION }}"

          try:
              with open('CHANGELOG.md', 'r', encoding='utf-8') as f:
                  content = f.read()
              
              # åŒ¹é…å½“å‰ç‰ˆæœ¬çš„ç« èŠ‚ (æ”¯æŒå¤šç§æ ¼å¼)
              # ä¾‹å¦‚: ## [0.2.0] æˆ– ## 0.2.0 æˆ– ## v0.2.0
              pattern = rf'^##\s+\[?v?{re.escape(version)}\]?.*?$'
              
              lines = content.split('\n')
              start_idx = None
              end_idx = None
              
              # æ‰¾åˆ°å½“å‰ç‰ˆæœ¬çš„å¼€å§‹ä½ç½®
              for i, line in enumerate(lines):
                  if re.match(pattern, line.strip(), re.IGNORECASE):
                      start_idx = i
                      break
              
              if start_idx is None:
                  print(f"âš ï¸ æœªåœ¨ CHANGELOG.md ä¸­æ‰¾åˆ°ç‰ˆæœ¬ {version} çš„è®°å½•")
                  print(f"\n## ğŸ“¦ Release {version}\n")
                  print("æ­¤ç‰ˆæœ¬çš„è¯¦ç»†å˜æ›´è®°å½•è¯·æŸ¥çœ‹ [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md)")
                  sys.exit(0)
              
              # æ‰¾åˆ°ä¸‹ä¸€ä¸ªç‰ˆæœ¬æ ‡é¢˜çš„ä½ç½®ï¼ˆå³å½“å‰ç‰ˆæœ¬å†…å®¹çš„ç»“æŸä½ç½®ï¼‰
              for i in range(start_idx + 1, len(lines)):
                  if re.match(r'^##\s+\[?v?\d+\.\d+', lines[i].strip()):
                      end_idx = i
                      break
              
              # æå–å½“å‰ç‰ˆæœ¬çš„å†…å®¹
              if end_idx:
                  version_content = '\n'.join(lines[start_idx+1:end_idx])
              else:
                  version_content = '\n'.join(lines[start_idx+1:])
              
              # æ¸…ç†å†…å®¹
              version_content = version_content.strip()
              
              # è¾“å‡ºæå–çš„å†…å®¹
              if version_content:
                  print(version_content)
              else:
                  print(f"## ğŸ“¦ Release {version}\n")
                  print("è¯¦ç»†å˜æ›´è¯·æŸ¥çœ‹ [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md)")

          except FileNotFoundError:
              print(f"âš ï¸ CHANGELOG.md æ–‡ä»¶ä¸å­˜åœ¨")
              print(f"\n## ğŸ“¦ Release {version}\n")
              print("è¯¦ç»†å˜æ›´è¯·æŸ¥çœ‹æäº¤è®°å½•")
          except Exception as e:
              print(f"âš ï¸ å¤„ç† CHANGELOG.md æ—¶å‡ºé”™: {e}")
              print(f"\n## ğŸ“¦ Release {version}\n")
              print("è¯¦ç»†å˜æ›´è¯·æŸ¥çœ‹æäº¤è®°å½•")
          PYTHON_SCRIPT

          # è¯»å–æå–çš„ changelog å†…å®¹
          CHANGELOG_CONTENT=$(cat changelog_content.md)

          # æ„å»ºå®Œæ•´çš„ Release Notes
          {
            echo "RELEASE_NOTES<<EOF"
            echo "$CHANGELOG_CONTENT"
            echo ""
            echo "---"
            echo ""
            echo "## ğŸ“¦ Installation"
            echo ""
            echo "\`\`\`bash"
            echo "pip install cmai==${{ steps.get_version.outputs.VERSION }}"
            echo "\`\`\`"
            echo ""
            echo "## ğŸ Supported Python Versions"
            echo ""
            echo "This release has been tested with Python 3.10, 3.11, 3.12 and 3.13."
            echo ""
            echo "## ğŸ”— Links"
            echo ""
            echo "- [ğŸ“‹ Full Changelog](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md)"
            echo "- [ğŸ“¦ PyPI Package](https://pypi.org/project/cmai/${{ steps.get_version.outputs.VERSION }}/)"
            echo "- [ğŸ“š Documentation](https://github.com/${{ github.repository }}#readme)"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      # åˆ›å»º GitHub Release
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: Release ${{ steps.get_version.outputs.VERSION }}
          tag_name: ${{ steps.get_version.outputs.TAG }}
          body: ${{ steps.release_notes.outputs.RELEASE_NOTES }}
          files: dist/*
          draft: false
          prerelease: ${{ contains(steps.get_version.outputs.VERSION, 'rc') || contains(steps.get_version.outputs.VERSION, 'beta') || contains(steps.get_version.outputs.VERSION, 'alpha') }}
          generate_release_notes: false # ç¦ç”¨è‡ªåŠ¨ç”Ÿæˆï¼Œå®Œå…¨ä½¿ç”¨æˆ‘ä»¬ä» CHANGELOG.md æå–çš„å†…å®¹
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ç¬¬ä¸‰æ­¥ï¼šéªŒè¯å‘å¸ƒ
  verify-release:
    name: Verify Release
    needs: build-and-publish
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, '[skip-pypi]')"
    strategy:
      fail-fast: false
      matrix:
        extra: ["base", "openai", "ollama", "zai", "anthropic", "all_providers"]

    steps:
      - name: Wait for PyPI to update
        run: sleep 60 # ç­‰å¾… PyPI ç´¢å¼•æ›´æ–°

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Get version
        id: get_version
        run: |
          echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Verify Installation
        run: |
          VERSION="${{ steps.get_version.outputs.VERSION }}"
          EXTRA="${{ matrix.extra }}"

          if [ "$EXTRA" == "base" ]; then
            PACKAGE="cmai==$VERSION"
            CHECK_CMD="import cmai"
          else
            PACKAGE="cmai[$EXTRA]==$VERSION"
            # ç®€å•çš„æ˜ å°„æ£€æŸ¥é€»è¾‘
            if [ "$EXTRA" == "openai" ]; then CHECK_CMD="import cmai, openai"; fi
            if [ "$EXTRA" == "ollama" ]; then CHECK_CMD="import cmai, ollama"; fi
            if [ "$EXTRA" == "all_providers" ]; then CHECK_CMD="import cmai, openai, ollama"; fi
          fi

          echo "Testing installation of: $PACKAGE"
          python -m pip install "$PACKAGE"

          echo "Verifying imports..."
          python -c "$CHECK_CMD"

          echo "âœ… Verification successful for $EXTRA"
