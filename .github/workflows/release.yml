name: Build, Release and Publish

on:
  push:
    tags:
      - "v*" # è§¦å‘æ¡ä»¶ï¼šæ¨é€ v å¼€å¤´çš„æ ‡ç­¾
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  # ç¬¬ä¸€æ­¥ï¼šåœ¨æ‰€æœ‰ Python ç‰ˆæœ¬ä¸Šæµ‹è¯•æ„å»º
  test-build:
    name: Test Build on Python ${{ matrix.python-version }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10", "3.11", "3.12", "3.13"]
      fail-fast: false

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          allow-prereleases: true

      - name: Display Python version
        run: python --version

      - name: Upgrade pip and install build tools
        run: |
          python -m pip install --upgrade pip
          python -m pip install build wheel setuptools

      - name: Install package dependencies
        run: |
          # å®‰è£…åŒ…åŠå…¶ä¾èµ–
          pip install .

      - name: Run tests (if any)
        run: |
          # å¦‚æœæœ‰æµ‹è¯•ï¼Œå–æ¶ˆæ³¨é‡Šä¸‹é¢çš„è¡Œ
          # python -m pytest tests/ -v
          echo "No tests configured yet"

      - name: Test build
        run: |
          python -m build
          ls -la dist/

  # ç¬¬äºŒæ­¥ï¼šæ­£å¼æ„å»ºå’Œå‘å¸ƒ
  build-and-publish:
    name: Build and Publish Package
    needs: test-build
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # è·å–æ‰€æœ‰å†å²ï¼Œä»¥ä¾¿ç”Ÿæˆæ›´å¥½çš„ changelog

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12" # ä½¿ç”¨ç¨³å®šç‰ˆæœ¬è¿›è¡Œå‘å¸ƒ

      - name: Upgrade pip and install build tools
        run: |
          python -m pip install --upgrade pip
          python -m pip install build wheel setuptools twine

      - name: Get version from tag
        id: get_version
        run: |
          echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          echo "TAG=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Verify version matches pyproject.toml
        run: |
          # å®‰è£… tomli ç”¨äº Python < 3.11
          pip install tomli
          PROJECT_VERSION=$(python -c "
          try:
              import tomllib
          except ImportError:
              import tomli as tomllib
          with open('pyproject.toml', 'rb') as f:
              data = tomllib.load(f)
              print(data['project']['version'])
          ")
          TAG_VERSION="${{ steps.get_version.outputs.VERSION }}"
          if [ "$PROJECT_VERSION" != "$TAG_VERSION" ]; then
            echo "Error: Tag version ($TAG_VERSION) doesn't match pyproject.toml version ($PROJECT_VERSION)"
            exit 1
          fi
          echo "Version check passed: $PROJECT_VERSION"

      - name: Build package
        run: |
          python -m build
          ls -la dist/
          echo "Built packages:"
          echo "---------------"
          ls -1 dist/

      - name: Check build output
        run: |
          # å®‰è£… wheel æ¥æµ‹è¯•
          pip install dist/*.whl
          python -c "import cmai; print(f'Successfully imported cmai')"
          pip show cmai

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: python-packages
          path: dist/
          retention-days: 30

      # æ£€æŸ¥åˆ†å‘åŒ…
      - name: Check distribution
        run: |
          twine check dist/*

      # å‘å¸ƒåˆ° PyPI
      - name: Publish to PyPI
        if: "!contains(github.event.head_commit.message, '[skip-pypi]')"
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          echo "Publishing to PyPI..."
          twine upload dist/*
          echo "Package published to PyPI"
          echo "Install with: pip install cmai==${{ steps.get_version.outputs.VERSION }}"

      # ç”Ÿæˆ Release Notes
      - name: Generate Release Notes
        id: release_notes
        run: |
          # è·å–ä¸Šä¸€ä¸ªæ ‡ç­¾
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 ${{ steps.get_version.outputs.TAG }}^ 2>/dev/null || echo "")

          # ç”Ÿæˆç®€å•çš„ changelog
          echo "RELEASE_NOTES<<EOF" >> $GITHUB_OUTPUT
          echo "## What's Changed" >> $GITHUB_OUTPUT

          if [ -n "$PREVIOUS_TAG" ]; then
            echo "" >> $GITHUB_OUTPUT
            echo "### Commits since $PREVIOUS_TAG" >> $GITHUB_OUTPUT
            git log --pretty=format:"- %s (%an)" $PREVIOUS_TAG..${{ steps.get_version.outputs.TAG }} >> $GITHUB_OUTPUT
          else
            echo "" >> $GITHUB_OUTPUT
            echo "Initial release ğŸ‰" >> $GITHUB_OUTPUT
          fi

          echo "" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "## Installation" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "\`\`\`bash" >> $GITHUB_OUTPUT
          echo "pip install cmai==${{ steps.get_version.outputs.VERSION }}" >> $GITHUB_OUTPUT
          echo "\`\`\`" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "## Supported Python Versions" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "This release has been tested with Python 3.10, 3.11, 3.12 and 3.13." >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "## Full Changelog" >> $GITHUB_OUTPUT
          if [ -n "$PREVIOUS_TAG" ]; then
            echo "https://github.com/${{ github.repository }}/compare/$PREVIOUS_TAG...${{ steps.get_version.outputs.TAG }}" >> $GITHUB_OUTPUT
          else
            echo "https://github.com/${{ github.repository }}/commits/${{ steps.get_version.outputs.TAG }}" >> $GITHUB_OUTPUT
          fi
          echo "EOF" >> $GITHUB_OUTPUT

      # åˆ›å»º GitHub Release
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: Release ${{ steps.get_version.outputs.VERSION }}
          tag_name: ${{ steps.get_version.outputs.TAG }}
          body: ${{ steps.release_notes.outputs.RELEASE_NOTES }}
          files: dist/*
          draft: false
          prerelease: ${{ contains(steps.get_version.outputs.VERSION, 'rc') || contains(steps.get_version.outputs.VERSION, 'beta') || contains(steps.get_version.outputs.VERSION, 'alpha') }}
          generate_release_notes: true # GitHub è‡ªåŠ¨ç”Ÿæˆçš„ release notes ä¼šè¿½åŠ åˆ°æˆ‘ä»¬çš„å†…å®¹åé¢
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ç¬¬ä¸‰æ­¥ï¼šéªŒè¯å‘å¸ƒ
  verify-release:
    name: Verify Release
    needs: build-and-publish
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, '[skip-pypi]')"

    steps:
      - name: Wait for PyPI to update
        run: sleep 60 # ç­‰å¾… PyPI ç´¢å¼•æ›´æ–°

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Get version
        id: get_version
        run: |
          echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Verify installation from PyPI
        run: |
          python -m pip install cmai==${{ steps.get_version.outputs.VERSION }}
          python -c "import cmai; print(f'Successfully installed and imported cmai')"
          pip show cmai
